---
title: "Homework 6: Linear Models"
author: "Kristina Howell"
output: github_document
---

```{r settings, message = FALSE}
# These settings will be used throughout the document.

library(tidyverse)
library(modelr)
library(p8105.datasets)
library(mgcv)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis", 
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)

`%notin%` <- Negate(`%in%`)
```

## Problem 1

#### Data Tidying

```{r import_1, message=FALSE, warning=FALSE}
homicide_df = 
  
  # Import the data
  read_csv("./data/homicide-data.txt", na = c("", "NA", "Unknown")) %>% 
  
  # Create city_state variable and binary resolved variable
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest" ~ 0,
      disposition == "Closed by arrest" ~ 1)) %>% 
  
  # Remove unnecessary cities
  filter(city_state != "Tulsa_AL") %>% 
           # c("Tulsa_AL", "Dallas_TX", "Phoenix_AZ", "Kansas City_MO")) 
           
  # Include specific races
  filter(victim_race %in% c("White", "Black")) %>% 
  
  # Convert age to a numeric
  mutate(victim_age = as.numeric(victim_age),
         victim_race = as.factor(victim_race),
         victim_sex = as.factor(victim_sex)) %>% 
  
  # Retain only important variables
  select(city_state, resolved, victim_age, victim_race, victim_sex)
```

#### Fitting the model for Baltimore

```{r}
# Create a dataframe with only Baltimore, MD
baltimore_df = 
  homicide_df %>% 
  filter(city_state == "Baltimore_MD")

# Fit a logistic regresison model 
glm(resolved ~ victim_age + victim_race + victim_sex,
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  
  # Obtain OR and CI
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)) %>% 
  
  # Retain necessary variables and create a table
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```

#### Mapping the model over the entire dataset

```{r}
models_results_df = 
  homicide_df %>% 
    nest(data = -city_state) %>% 
    mutate(
      models = 
        map(.x = data, 
            ~glm(resolved ~ victim_age + victim_race + victim_sex,
                 data = .x,
                 family = binomial())), 
      results = map(models, broom::tidy)) %>% 
    select(city_state, results) %>% 
    unnest(results) %>% 
    mutate(
      OR = exp(estimate),
      CI_lower = exp(estimate - 1.96 * std.error),
      CI_upper = exp(estimate + 1.96 * std.error)) %>% 
  select(city_state, term, OR, starts_with("CI"))
```

#### Visualization

```{r}
models_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
    geom_point() +
    geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

## Problem 2

#### Import and Tidy Data

```{r message=FALSE, warning=FALSE}
bwt_df = 
  
  # Import dataset using read_csv
  read_csv("./data/birthweight.csv") %>% 
  drop_na() %>% 
  
  # Retain only necessary variables
  select(bwt, blength, gaweeks, bhead, babysex, wtgain, mrace, fincome) %>% 
  
  # Relabel race categories and convert to factor
   mutate(
     mrace = case_when(
      mrace == 1 ~ "White",
      mrace == 2 ~ "Black",
      mrace == 3 ~ "Asian",
      mrace == 4 ~ "Puerto Rican",
      mrace == 8 ~ "Other"),
     mrace = as.factor(mrace),
    
  # Relabel baby's sex categories and convert to factor
    babysex = case_when(
      babysex == 1 ~ "Male",
      babysex == 2 ~ "Female"), 
   babysex = as.factor(babysex))

```

The first prespecified models are as follows:

* **Model 1:** birthweight ~ length at birth + gestational age

* **Model 2:** birthweight ~ head circumference | length | sex

My proposed model focuses on the mother's weight gain during pregnancy in pounds `wtgain` and family income `fincome` on the outcome variable, birthweight `btw`. This model is based on the social determinants of health, nutritional access, and financial barriers that may affect the health of the mother and baby, measured through birthweight. 

The model is as follows:

* **Model 3:** birthweight ~ wtgain + fincome

#### Fit linear models

```{r}
fit1 = lm(bwt ~ blength + gaweeks, data = bwt_df)

fit2 = lm(bwt ~ blength + bhead + babysex + 
                blength*bhead + blength*babysex + bhead*babysex +
                blength*bhead*babysex,
              data = bwt_df)

fit3 = lm(bwt ~ wtgain + fincome, data = bwt_df)

fit1 %>% 
broom::tidy()

fit2 %>% 
broom::tidy()

fit3 %>% 
broom::tidy()
```

#### Check residual plots

```{r}
modelr::add_residuals(bwt_df, fit3) %>% 
  ggplot(aes(x = wtgain, y = resid, color = fincome)) +
  geom_point()  

bwt_df %>% 
  modelr::add_residuals(fit3) %>% 
  ggplot(aes(x = fincome, y = resid, color = wtgain)) + 
  geom_point(alpha = 0.8) 
```

With both predictors, residuals appear randomly scattered around the 0 line. 

#### Cross validation

```{r}
cv_df = 
  crossv_mc(bwt_df, 100) %>% 
  
  mutate(
    train = map(train, as_tibble), 
    test = map(test, as_tibble)) %>% 
  
  mutate(
      fit1 = 
        map(.x = train, ~lm(bwt ~ blength + gaweeks, data = .x)),
      
      fit2 = 
        map(.x = train, ~lm(bwt ~ blength + bhead + babysex + 
                            blength*bhead + blength*babysex + bhead*babysex +
                            blength*bhead*babysex, 
                          data = .x)),
      
      fit3 = 
        map(.x = train, ~lm(bwt ~ wtgain + fincome, data = .x))) %>% 
  
  mutate(
      rmse_fit1 = map2_dbl(.x = fit1, .y = test, 
                             ~rmse(model = .x, data = .y)),
      rmse_fit2 = map2_dbl(.x = fit2, .y = test, 
                             ~rmse(model = .x, data = .y)),
      rmse_fit3 = map2_dbl(.x = fit3, .y = test, 
                             ~rmse(model = .x, data = .y)))
```


#### Analysis of results

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse", 
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin()
```

#### Calculate average RMSE

```{r}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse", 
    names_prefix = "rmse_"
  ) %>% 
  group_by(model) %>% 
  summarize(avg_rmse = mean(rmse))
```


#### Extra code

```{r}
bwt_df %>% 
ggplot(aes(x = wtgain, y = bwt)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = F,
              aes(group = fincome,                                  
              color = fincome))

bwt_df %>% 
ggplot(aes(x = fincome, y = bwt)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm")
```


```{r, eval = FALSE}
bwt_df %>% 
  add_predictions(fit) %>% 
  ggplot(aes(x = wtgain, y = bwt)) + 
  geom_point() +
  geom_line(aes(y = pred), color = "blue")
```


### Problem 3

Import the data

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```



